<!doctype html>
<style>
  html { background-color: #000; color: #fff; }
  body { text-align: center; }
  input, button, select { background-color: #111; border: 1px solid #777; color: #fff; padding: 0.5em; }
  a, a:hover, a:visited { color: rgb(236, 103, 44); text-decoration: none; }
  #nav a { padding: 0 2em; }
</style>
<meta name="description" content="Monero/Bitcoin cryptocurrency exchange with 0% trading fees. No sign up required."/>
<meta name=”robots” content="index, follow"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="keywords" content="Monero, Bitcoin, Exchange"/>
<meta charset="UTF-8"/>
<script src="/decimal.js"></script>
<script>
  function round_to_18_decimal_places(amount) {
    return new Decimal(amount.toFixed(18, Decimal.ROUND_DOWN));
  }
  function round_up_to_18_decimal_places(amount) {
    return new Decimal(amount.toFixed(18, Decimal.ROUND_UP));
  }
  async function calculate() {
    const order_type = document.getElementsByName('type')[0].value;
    document.getElementById('result').innerHTML = '<p>Calculating...</p>';
    let amount = null;
    try {
      amount = new Decimal(document.getElementById("amount").value);
    } catch (e) {
      document.getElementById('result').innerHTML = '<p>Please input a decimal amount.</p>';
      return;
    }
    let order_book = null;
    try {
      const response = await fetch("/order_book?market=XMRBTC");
      order_book = await response.json();
    } catch (e) {
      document.getElementById('result').innerHTML = '<p>There was an error fetching the exchange rate, please try again.</p>';
      return;
    }
    order_book.sell.sort((a, b) => Decimal.sub(a.price, b.price).toNumber());
    order_book.buy.sort((a, b) => Decimal.sub(b.price, a.price).toNumber());
    let amount_exchanged = new Decimal('0');
    if (order_type == 'buy') {
      let approximate_cost = new Decimal('0');
      for (let i = 0; i < order_book.sell.length; i++) {
        const amount_to_exchange = Decimal.min(Decimal.sub(order_book.sell[i].amount, order_book.sell[i].executed), amount);
        const cost = round_up_to_18_decimal_places(Decimal.mul(order_book.sell[i].price, amount_to_exchange));
        approximate_cost = approximate_cost.add(cost);
        amount_exchanged = amount_exchanged.add(amount_to_exchange);
        amount = amount.sub(amount_to_exchange);
        if (amount.eq(new Decimal(0))) {
          break;
        }
      }
      approximate_cost = approximate_cost.add(new Decimal('0.00001'));
      if (amount.eq(new Decimal(0))) {
        document.getElementById('result').innerHTML =
          `<p>This will cost approximately ${approximate_cost.toFixed(8, Decimal.ROUND_UP)} BTC.</p>`;
      } else {
        document.getElementById('result').innerHTML =
          `<p>We can only exchange ${amount_exchanged.toFixed(12, Decimal.ROUND_DOWN)} XMR at the moment.</p>` +
          `<p>This will cost approximately ${approximate_cost.toFixed(8, Decimal.ROUND_UP)} BTC.</p>`;
      }
    } else {
      let approximate_value = new Decimal('0');
      for (let i = 0; i < order_book.buy.length; i++) {
        const amount_to_exchange = Decimal.min(Decimal.sub(order_book.buy[i].amount, order_book.buy[i].executed), amount);
        const value = round_to_18_decimal_places(Decimal.mul(order_book.buy[i].price, amount_to_exchange));
        approximate_value = approximate_value.add(value);
        amount_exchanged = amount_exchanged.add(amount_to_exchange);
        amount = amount.sub(amount_to_exchange);
        if (amount.eq(new Decimal(0))) {
          break;
        }
      }
      approximate_value = approximate_value.mul(new Decimal('0.998')).sub(new Decimal('0.0001'));
      if (amount.eq(new Decimal(0))) {
        document.getElementById('result').innerHTML =
          `<p>This has value of approximately ${approximate_value.toFixed(8, Decimal.ROUND_UP)} BTC.</p>`;
      } else {
        document.getElementById('result').innerHTML =
          `<p>We can only exchange ${amount_exchanged.toFixed(12, Decimal.ROUND_DOWN)} XMR at the moment.</p>` +
          `<p>This has value of approximately ${approximate_value.toFixed(8, Decimal.ROUND_UP)} BTC.</p>`;
      }
    }
  }
  function update_placeholders() {
    const order_type = document.getElementsByName('type')[0].value;
    if (order_type == 'buy') {
      document.getElementsByName('withdrawal_address')[0].placeholder = 'Your XMR address';
      document.getElementsByName('refund_address')[0].placeholder = 'Your BTC refund address';
    } else {
      document.getElementsByName('withdrawal_address')[0].placeholder = 'Your BTC address';
      document.getElementsByName('refund_address')[0].placeholder = 'Your XMR refund address';
    }
  }
</script>
<title>Fryx Finance</title>
<body onload="update_placeholders()">
<p id="nav"><a href="/">Exchange</a> <a href="/api">API Documentation</a></p>
<h1><img src="/header.png"/></h1>
<form action="/" method="post">
  <p>
    <select name="type" onChange='update_placeholders()'>
      <option value="buy"{% if order_type == 'buy' %} selected="selected"{% endif %}>Buy</option>
      <option value="sell"{% if order_type == 'sell' %} selected="selected"{% endif %}>Sell</option>
    </select>
    <input id="amount" placeholder="Amount of Monero"/>
    <button type="button" onClick="calculate()">Calculate approximate rate</button>
  </p>
  <div id="result"></div>
  <p>If we can't fulfil your entire order, we will refund the amount that was not exchanged.</p>
  {% if error %}
    <p>{{ error }}</p>
  {% endif %}
  <input type="hidden" name="market" value="XMRBTC"/>
  <p><input name="withdrawal_address" size="100" placeholder="Your withdrawal address"/></p>
  <p><input name="refund_address" size="100" placeholder="Your refund address"/></p>
  <p><input type="Submit" value="Buy Monero"/></p>
</form>
</body>
